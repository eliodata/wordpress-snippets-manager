{
  "id": "121",
  "name": "Page de commande client documents liste stagiaires... formulaire envoi côté admin détails commande",
  "description": "* Active: true  Active: true  Active: true  Active: true  Active: true  Active: true  Active: true  Active: true  Active: true",
  "code": "/**\n * Affiche la liste des stagiaires (Prénom / Nom / Date de naissance)\n * sous le détail de la commande sur la page \"Mon Compte > Commandes\"\n */\nadd_action('woocommerce_order_details_after_order_table', 'fsbdd_show_stagiaires_on_order_page', 10, 1);\n\nfunction fsbdd_show_stagiaires_on_order_page($order) {\n    // $order peut être un WC_Order ou un ID selon la version.\n    if (is_numeric($order)) {\n        $order = wc_get_order($order);\n    }\n\n    if (!$order instanceof WC_Order) {\n        return; // Sécurité\n    }\n\n    // 1) Récupérer le meta \"fsbdd_gpeffectif\"\n    //    qui contient le tableau sérialisé des stagiaires\n    $gpeffectif = $order->get_meta('fsbdd_gpeffectif', true);\n    if (empty($gpeffectif) || !is_array($gpeffectif)) {\n        // Rien à afficher\n        return;\n    }\n\n    // 2) Construire le tableau de stagiaires\n    //    Chaque item est de la forme:\n    //      [\n    //        \"fsbdd_prenomstagiaire\"  => \"Frédéric\",\n    //        \"fsbdd_nomstagiaire\"     => \"Garnault\",\n    //        \"fsbdd_stagidatenaiss\"   => \"28/01/2000\"\n    //      ]\n    $stagiaires = array();\n    foreach ($gpeffectif as $item) {\n        $prenom = isset($item['fsbdd_prenomstagiaire']) ? trim($item['fsbdd_prenomstagiaire']) : '';\n        $nom    = isset($item['fsbdd_nomstagiaire'])    ? trim($item['fsbdd_nomstagiaire'])    : '';\n        $dnaiss = isset($item['fsbdd_stagidatenaiss'])  ? trim($item['fsbdd_stagidatenaiss'])  : '';\n\n        // S'il y a a minima prénom ou nom, on l'ajoute\n        if ($prenom || $nom || $dnaiss) {\n            $stagiaires[] = array(\n                'prenom' => $prenom,\n                'nom'    => $nom,\n                'dnaiss' => $dnaiss,\n            );\n        }\n    }\n\n    // Si aucun stagiaire valide\n    if (empty($stagiaires)) {\n        return;\n    }\n\n    // 3) Afficher un titre et un tableau\n    //    Vous pouvez personnaliser le HTML / style selon vos préférences.\n    ?>\n<h2><span class=\"dashicons dashicons-groups\" style=\"margin-right: 8px;\"></span><?php esc_html_e('Stagiaires', 'woocommerce'); ?></h2>\n<table class=\"shop_table shop_table_responsive\" style=\"margin-bottom:20px;\">\n    <thead>\n        <tr>\n            <th><?php esc_html_e('Prénom', 'woocommerce'); ?></th>\n            <th><?php esc_html_e('Nom', 'woocommerce'); ?></th>\n            <th><?php esc_html_e('Date de naissance', 'woocommerce'); ?></th>\n        </tr>\n    </thead>\n    <tbody>\n        <?php foreach ($stagiaires as $stagiaire) : ?>\n            <tr>\n                <td data-title=\"<?php esc_attr_e('Prénom', 'woocommerce'); ?>\"><?php echo esc_html($stagiaire['prenom']); ?></td>\n                <td data-title=\"<?php esc_attr_e('Nom', 'woocommerce'); ?>\"><?php echo esc_html($stagiaire['nom']); ?></td>\n                <td data-title=\"<?php esc_attr_e('Date de naissance', 'woocommerce'); ?>\"><?php echo esc_html($stagiaire['dnaiss']); ?></td>\n            </tr>\n        <?php endforeach; ?>\n    </tbody>\n</table>\n\n    <?php\n}\n\n/**\n * Helper: Récupérer l'ID de l'action de formation liée à une commande (pour émargements)\n */\nfunction get_action_formation_from_order($order_id) {\n    $order = wc_get_order($order_id);\n    if (!$order) {\n        return false;\n    }\n\n    // Parcourir les items de la commande pour trouver l'action de formation liée\n    $items = $order->get_items();\n    foreach ($items as $item) {\n        $action_id = wc_get_order_item_meta($item->get_id(), 'fsbdd_relsessaction_cpt_produit', true);\n        if (!empty($action_id)) {\n            return $action_id;\n        }\n    }\n\n    return false;\n}\n\n/**\n * Helper: Récupérer les émargements pour une commande\n */\nfunction get_emargements_for_order($order_id) {\n    if (!defined('FSBDD_UPLOAD_DIR_PATH')) {\n        return array();\n    }\n\n    $action_id = get_action_formation_from_order($order_id);\n    if (!$action_id) {\n        return array();\n    }\n\n    $action_title_slug = sanitize_title(get_the_title($action_id));\n    $formateur_ids = function_exists('fsbdd_get_action_formateur_ids') ? fsbdd_get_action_formateur_ids($action_id) : array();\n    \n    $emargements = array();\n\n    if (!empty($formateur_ids)) {\n        foreach ($formateur_ids as $formateur_id) {\n            if (!function_exists('fsbdd_get_trainer_action_dir_path')) {\n                continue;\n            }\n            \n            $action_dir = fsbdd_get_trainer_action_dir_path($formateur_id, $action_title_slug);\n            $files_in_dir = is_dir($action_dir) ? glob($action_dir . '/*') : array();\n\n            if (!empty($files_in_dir)) {\n                foreach ($files_in_dir as $file_path) {\n                    if (is_dir($file_path)) continue;\n                    $file_name = basename($file_path);\n                    \n                    // Vérifier si c'est un émargement\n                    if (strpos($file_name, 'emargements') !== false) {\n                        $secure_url = add_query_arg(\n                            'fsbdd_file',\n                            urlencode(str_replace(FSBDD_UPLOAD_DIR_PATH . '/', '', $file_path)),\n                            site_url('/')\n                        );\n                        \n                        $emargements[] = array(\n                            'file_name' => $file_name,\n                            'url' => $secure_url,\n                            'formateur_id' => $formateur_id\n                        );\n                    }\n                }\n            }\n        }\n    }\n\n    return $emargements;\n}\n\nadd_action('wp_enqueue_scripts', 'fsbdd_frontend_documents_styles');\nfunction fsbdd_frontend_documents_styles() {\n    if (is_account_page() || is_wc_endpoint_url('view-order')) {\n        $custom_css = \"\n            /* Styles pour les tableaux responsive */\n            .shop_table_responsive {\n                width: 100%;\n                border-collapse: collapse;\n                table-layout: auto;\n                background: #fff;\n                box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n                border-radius: 3px;\n                overflow: hidden;\n                margin-bottom: 20px;\n            }\n            \n            .shop_table_responsive th, \n            .shop_table_responsive td {\n                padding: 10px;\n                text-align: left;\n                border: 1px solid #ddd;\n                white-space: nowrap;\n            }\n            \n            .shop_table_responsive th {\n                background-color: #f4f4f4;\n                font-weight: bold;\n            }\n            \n            .shop_table_responsive tbody tr {\n                transition: background-color 0.2s ease;\n            }\n            \n            .shop_table_responsive tbody tr:hover {\n                background-color: #f8f9fa;\n            }\n\n            /* Styles pour la section documents */\n            .documents-section {\n                background: #fff;\n                border-radius: 3px;\n                box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n                margin: 25px 0;\n                overflow: hidden;\n            }\n            \n            .documents-header {\n                background-color: #314150;\n                color: white;\n                padding: 12px 15px;\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n            \n            .documents-header h2 {\n                margin: 0;\n                font-size: 16px;\n                font-weight: 600;\n            }\n            \n            .documents-header .dashicons {\n                font-size: 16px;\n            }\n            \n            .documents-content {\n                padding: 0;\n            }\n            \n            .documents-table {\n                width: 100%;\n                border-collapse: collapse;\n                margin: 0;\n            }\n            \n            .documents-table tbody tr {\n                border-bottom: 1px solid #e8ecf0;\n                transition: background-color 0.2s ease;\n            }\n            \n            .documents-table tbody tr:last-child {\n                border-bottom: none;\n            }\n            \n            .documents-table tbody tr:hover {\n                background-color: #f8f9fa;\n            }\n            \n            .documents-table td {\n                padding: 12px 15px;\n                vertical-align: middle;\n                font-size: 14px;\n            }\n            \n            .documents-table .doc-type {\n                font-weight: 600;\n                color: #2d3748;\n                min-width: 140px;\n            }\n            \n            .documents-table .doc-actions {\n                text-align: right;\n            }\n            \n            .doc-download-btn {\n                display: inline-flex;\n                align-items: center;\n                gap: 6px;\n                background: #48bb78;\n                color: white;\n                text-decoration: none;\n                padding: 6px 12px;\n                border-radius: 3px;\n                font-weight: 500;\n                font-size: 12px;\n                transition: background-color 0.2s ease;\n            }\n            \n            .doc-download-btn:hover {\n                background: #38a169;\n                color: white;\n                text-decoration: none;\n            }\n            \n            .doc-download-btn .dashicons {\n                font-size: 14px;\n            }\n            \n            .no-documents {\n                padding: 30px 20px;\n                text-align: center;\n                color: #718096;\n                font-style: italic;\n            }\n            \n            .no-documents .dashicons {\n                font-size: 48px;\n                color: #e2e8f0;\n                margin-bottom: 15px;\n            }\n\n            /* Responsive */\n            @media (max-width: 768px) {\n                .shop_table_responsive,\n                .documents-section {\n                    font-size: 12px;\n                }\n                \n                .shop_table_responsive th, \n                .shop_table_responsive td,\n                .documents-table td {\n                    padding: 5px;\n                }\n                \n                .documents-header {\n                    padding: 10px 15px;\n                }\n                \n                .documents-header h2 {\n                    font-size: 14px;\n                }\n                \n                .documents-table td {\n                    padding: 10px 15px;\n                }\n                \n                .doc-download-btn {\n                    padding: 5px 10px;\n                    font-size: 11px;\n                }\n                \n                .documents-table .doc-type {\n                    min-width: auto;\n                    font-size: 12px;\n                }\n            }\n            \n            @media (max-width: 480px) {\n                .documents-table {\n                    display: block;\n                }\n                \n                .documents-table tbody,\n                .documents-table tr,\n                .documents-table td {\n                    display: block;\n                    width: 100%;\n                }\n                \n                .documents-table tr {\n                    border: 1px solid #e8ecf0;\n                    border-radius: 3px;\n                    margin-bottom: 10px;\n                    padding: 10px;\n                    background: #fff;\n                }\n                \n                .documents-table td {\n                    padding: 5px 0;\n                    border: none;\n                    text-align: left;\n                }\n                \n                .documents-table .doc-type {\n                    font-size: 13px;\n                    margin-bottom: 5px;\n                    padding-bottom: 5px;\n                    border-bottom: 1px solid #e8ecf0;\n                }\n                \n                .documents-table .doc-actions {\n                    text-align: left;\n                    margin-top: 8px;\n                }\n            }\n        \";\n        wp_add_inline_style('woocommerce-general', $custom_css);\n    }\n}\n\n// ===============================\n// 1) FONCTION GÉNÉRIQUE D'AFFICHAGE DES DOCUMENTS AMÉLIORÉE\n// ===============================\nfunction afficher_documents_avec_checkboxes($order_id, $context) {\n    $upload_dir = wp_upload_dir();\n    $pdf_folder = $upload_dir['basedir'] . '/pdfclients/';\n    \n    $documents_affiches = false;\n    $all_documents = array();\n\n    // 1. Récupérer les documents du dossier pdfclients (existant)\n    if (is_dir($pdf_folder)) {\n        $dir = opendir($pdf_folder);\n        if ($dir) {\n            while (($file = readdir($dir)) !== false) {\n                if (preg_match('/\\b' . preg_quote($order_id, '/') . '\\b/', $file) && pathinfo($file, PATHINFO_EXTENSION) === 'pdf') {\n                    $file_path = $upload_dir['baseurl'] . '/pdfclients/' . $file;\n                    \n                    // Déterminer le type de document par son préfixe\n                    $type_document = 'Document';\n                    if (strpos($file, 'devis-') === 0) {\n                        $type_document = 'Devis';\n                    } elseif (strpos($file, 'convention-') === 0) {\n                        $type_document = 'Convention';\n                    } elseif (strpos($file, 'convocation-') === 0) {\n                        $type_document = 'Convocation';\n                    } elseif (strpos($file, 'avenant-') === 0) {\n                        $type_document = 'Avenant';\n                    } elseif (strpos($file, 'realisation-') === 0) {\n                        $type_document = 'Certificat de réalisation';\n                    } elseif (strpos($file, 'attestation-') === 0) {\n                        $type_document = 'Attestation de formation';\n                    }\n\n                    $all_documents[] = array(\n                        'type' => $type_document,\n                        'url' => $file_path,\n                        'file_name' => $file,\n                        'source' => 'pdfclients'\n                    );\n                }\n            }\n            closedir($dir);\n        }\n    }\n\n    // 2. Récupérer les émargements (nouveau - seulement côté client)\n    if ($context === 'client') {\n        $emargements = get_emargements_for_order($order_id);\n        foreach ($emargements as $emargement) {\n            $all_documents[] = array(\n                'type' => 'Émargements',\n                'url' => $emargement['url'],\n                'file_name' => $emargement['file_name'],\n                'source' => 'emargements'\n            );\n        }\n    }\n\n    // 3. Affichage avec checkboxes pour admin\n     if ($context === 'admin') {\n         echo '<table style=\"width: 100%; border-collapse: collapse; margin-top: 6px; font-size: 11px;\">';\n         echo '<tbody>';\n\n        if (!empty($all_documents)) {\n            foreach ($all_documents as $document) {\n                echo '<tr>';\n                echo '<td style=\"padding: 2px; border-bottom: 1px solid #ddd; width: 20px;\">';\n                 if ($document['source'] === 'pdfclients') {\n                     echo '<input type=\"checkbox\" name=\"files_to_delete[]\" value=\"' . esc_attr($document['file_name']) . '\" class=\"doc-checkbox\" />';\n                 }\n                 echo '</td>';\n                 echo '<td style=\"padding: 2px 4px; border-bottom: 1px solid #ddd; font-weight: 600; font-size: 10px;\">' . esc_html($document['type']) . '</td>';\n                 echo '<td style=\"padding: 2px; border-bottom: 1px solid #ddd;\">';\n\n                if ($document['source'] === 'pdfclients') {\n                    // Actions admin pour les documents pdfclients\n                    echo '<a href=\"' . esc_url($document['url']) . '\" target=\"_blank\" style=\"text-decoration: none;\">\n                            <span class=\"dashicons dashicons-visibility\" style=\"margin-left: 4px;\"></span>\n                          </a>';\n                    \n                    $delete_url = add_query_arg(\n                        array(\n                            'action' => 'delete_pdf_client',\n                            'post_id' => $order_id,\n                            'file' => urlencode($document['file_name']),\n                            '_wpnonce' => wp_create_nonce('delete_pdf_client_' . $document['file_name'])\n                        ),\n                        admin_url('admin-post.php')\n                    );\n                    \n                    echo '<a href=\"' . esc_url($delete_url) . '\" class=\"delete-pdf-link\" style=\"text-decoration: none;\">\n                            <span class=\"dashicons dashicons-trash\" style=\"margin-left: 4px; color: #dc3545;\"></span>\n                          </a>';\n                } else {\n                    // Pour les émargements, juste un lien de visualisation\n                    echo '<a href=\"' . esc_url($document['url']) . '\" target=\"_blank\" style=\"text-decoration: none;\">\n                            <span class=\"dashicons dashicons-visibility\" style=\"margin-left: 4px;\"></span>\n                          </a>';\n                }\n                echo '</td>';\n                echo '</tr>';\n            }\n        } else {\n            echo '<tr>';\n            echo '<td colspan=\"3\" style=\"padding: 4px; text-align: center; border-bottom: 1px solid #ddd;\">Aucun document disponible</td>';\n            echo '</tr>';\n        }\n\n        echo '</tbody>';\n        echo '</table>';\n        \n        // JavaScript pour la gestion des checkboxes\n        ?>\n        <script>\n        jQuery(document).ready(function($) {\n            // Gestion du bouton \"Tout sélectionner\"\n            $('#select-all-docs').on('click', function() {\n                var $checkboxes = $('.doc-checkbox');\n                var allChecked = $checkboxes.length === $checkboxes.filter(':checked').length;\n                $checkboxes.prop('checked', !allChecked);\n                $(this).text(allChecked ? 'Tout sélectionner' : 'Tout désélectionner');\n                toggleBulkDeleteButton();\n            });\n            \n            // Gestion des checkboxes individuelles\n            $('.doc-checkbox').on('change', function() {\n                toggleBulkDeleteButton();\n                updateSelectAllButton();\n            });\n            \n            function toggleBulkDeleteButton() {\n                var hasChecked = $('.doc-checkbox:checked').length > 0;\n                $('#bulk-delete-btn').prop('disabled', !hasChecked);\n            }\n            \n            function updateSelectAllButton() {\n                var $checkboxes = $('.doc-checkbox');\n                var allChecked = $checkboxes.length === $checkboxes.filter(':checked').length;\n                $('#select-all-docs').text(allChecked ? 'Tout désélectionner' : 'Tout sélectionner');\n            }\n            \n            // Confirmation pour la suppression en lot\n            $('#bulk-delete-form').on('submit', function(e) {\n                var checkedCount = $('.doc-checkbox:checked').length;\n                if (checkedCount === 0) {\n                    e.preventDefault();\n                    return false;\n                }\n                \n                var message = checkedCount === 1 ? \n                    'Êtes-vous sûr de vouloir supprimer ce document ?' :\n                    'Êtes-vous sûr de vouloir supprimer ces ' + checkedCount + ' documents ?';\n                    \n                if (!confirm(message)) {\n                    e.preventDefault();\n                    return false;\n                }\n            });\n        });\n        </script>\n        <style>\n        .bulk-actions-row {\n            margin-top: 10px;\n            display: flex;\n            gap: 8px;\n        }\n        \n        .doc-select-all-btn, .doc-bulk-delete-btn {\n            padding: 6px 12px;\n            border: none;\n            border-radius: 3px;\n            font-size: 12px;\n            cursor: pointer;\n            transition: all 0.2s ease;\n        }\n        \n        .doc-select-all-btn {\n            background-color: #0073aa;\n            color: white;\n        }\n        \n        .doc-select-all-btn:hover {\n            background-color: #005a87;\n        }\n        \n        .doc-bulk-delete-btn {\n            background-color: #dc3545;\n            color: white;\n        }\n        \n        .doc-bulk-delete-btn:hover:not(:disabled) {\n            background-color: #c82333;\n        }\n        \n        .doc-bulk-delete-btn:disabled {\n            background-color: #6c757d;\n            cursor: not-allowed;\n            opacity: 0.6;\n        }\n        \n        .doc-checkbox {\n            margin: 0;\n        }\n        </style>\n        <?php\n    }\n}\n\nfunction afficher_documents($order_id, $context) {\n    $upload_dir = wp_upload_dir();\n    $pdf_folder = $upload_dir['basedir'] . '/pdfclients/';\n    \n    $documents_affiches = false;\n    $all_documents = array();\n\n    // 1. Récupérer les documents du dossier pdfclients (existant)\n    if (is_dir($pdf_folder)) {\n        $dir = opendir($pdf_folder);\n        if ($dir) {\n            while (($file = readdir($dir)) !== false) {\n                if (preg_match('/\\b' . preg_quote($order_id, '/') . '\\b/', $file) && pathinfo($file, PATHINFO_EXTENSION) === 'pdf') {\n                    $file_path = $upload_dir['baseurl'] . '/pdfclients/' . $file;\n                    \n                    // Déterminer le type de document par son préfixe\n                    $type_document = 'Document';\n                    if (strpos($file, 'devis-') === 0) {\n                        $type_document = 'Devis';\n                    } elseif (strpos($file, 'convention-') === 0) {\n                        $type_document = 'Convention';\n                    } elseif (strpos($file, 'convocation-') === 0) {\n                        $type_document = 'Convocation';\n                    } elseif (strpos($file, 'avenant-') === 0) {\n                        $type_document = 'Avenant';\n                    } elseif (strpos($file, 'realisation-') === 0) {\n                        $type_document = 'Certificat de réalisation';\n                    } elseif (strpos($file, 'attestation-') === 0) {\n                        $type_document = 'Attestation de formation';\n                    }\n\n                    $all_documents[] = array(\n                        'type' => $type_document,\n                        'url' => $file_path,\n                        'file_name' => $file,\n                        'source' => 'pdfclients'\n                    );\n                }\n            }\n            closedir($dir);\n        }\n    }\n\n    // 2. Récupérer les émargements (nouveau - seulement côté client)\n    if ($context === 'client') {\n        $emargements = get_emargements_for_order($order_id);\n        foreach ($emargements as $emargement) {\n            $all_documents[] = array(\n                'type' => 'Émargements',\n                'url' => $emargement['url'],\n                'file_name' => $emargement['file_name'],\n                'source' => 'emargements'\n            );\n        }\n    }\n\n    // 3. Affichage\n    if ($context === 'client') {\n        // Style moderne pour le front-end\n        if (!empty($all_documents)) {\n            echo '<div class=\"documents-section\">';\n            echo '<div class=\"documents-header\">';\n            echo '<span class=\"dashicons dashicons-media-document\"></span>';\n            echo '<h2>Documents de formation</h2>';\n            echo '</div>';\n            echo '<div class=\"documents-content\">';\n            echo '<table class=\"documents-table\">';\n            echo '<tbody>';\n\n            foreach ($all_documents as $document) {\n                echo '<tr>';\n                echo '<td class=\"doc-type\">' . esc_html($document['type']) . '</td>';\n                echo '<td class=\"doc-actions\">';\n                echo '<a href=\"' . esc_url($document['url']) . '\" download class=\"doc-download-btn\">';\n                echo 'Télécharger <span class=\"dashicons dashicons-download\"></span>';\n                echo '</a>';\n                echo '</td>';\n                echo '</tr>';\n            }\n\n            echo '</tbody>';\n            echo '</table>';\n            echo '</div>';\n            echo '</div>';\n        } else {\n            echo '<div class=\"documents-section\">';\n            echo '<div class=\"documents-header\">';\n            echo '<span class=\"dashicons dashicons-media-document\"></span>';\n            echo '<h2>Documents de formation</h2>';\n            echo '</div>';\n            echo '<div class=\"no-documents\">';\n            echo '<div class=\"dashicons dashicons-portfolio\"></div>';\n            echo '<p>Aucun document disponible pour cette formation.</p>';\n            echo '</div>';\n            echo '</div>';\n        }\n    } else {\n        // Style admin existant (backend)\n        echo '<table style=\"width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px;\">';\n        echo '<tbody>';\n\n        if (!empty($all_documents)) {\n            foreach ($all_documents as $document) {\n                echo '<tr>';\n                echo '<td style=\"padding: 4px; border-bottom: 1px solid #ddd; font-weight: 700;\">' . esc_html($document['type']) . '</td>';\n                echo '<td style=\"padding: 4px; border-bottom: 1px solid #ddd;\">';\n\n                if ($document['source'] === 'pdfclients') {\n                    // Actions admin pour les documents pdfclients\n                    echo '<a href=\"' . esc_url($document['url']) . '\" target=\"_blank\" style=\"text-decoration: none;\">\n                            <span class=\"dashicons dashicons-visibility\" style=\"margin-left: 4px;\"></span>\n                          </a>';\n                    \n                    $delete_url = add_query_arg(\n                        array(\n                            'action' => 'delete_pdf_client',\n                            'post_id' => $order_id,\n                            'file' => urlencode($document['file_name']),\n                            '_wpnonce' => wp_create_nonce('delete_pdf_client_' . $document['file_name'])\n                        ),\n                        admin_url('admin-post.php')\n                    );\n                    \n                    echo '<a href=\"' . esc_url($delete_url) . '\" class=\"delete-pdf-link\" style=\"text-decoration: none;\">\n                            <span class=\"dashicons dashicons-trash\" style=\"margin-left: 4px; color: #dc3545;\"></span>\n                          </a>';\n                } else {\n                    // Pour les émargements, juste un lien de visualisation\n                    echo '<a href=\"' . esc_url($document['url']) . '\" target=\"_blank\" style=\"text-decoration: none;\">\n                            <span class=\"dashicons dashicons-visibility\" style=\"margin-left: 4px;\"></span>\n                          </a>';\n                }\n                echo '</td>';\n                echo '</tr>';\n            }\n        } else {\n            echo '<tr>';\n            echo '<td colspan=\"2\" style=\"padding: 4px; text-align: center; border-bottom: 1px solid #ddd;\">Aucun document disponible</td>';\n            echo '</tr>';\n        }\n\n        echo '</tbody>';\n        echo '</table>';\n    }\n}\n\n// ===============================\n// 2) AFFICHER LES DOCUMENTS CÔTÉ CLIENT\n// ===============================\nadd_action('woocommerce_order_details_before_order_table', 'afficher_documents_client', 10, 1);\nfunction afficher_documents_client($order) {\n    afficher_documents($order->get_id(), 'client');\n}\n\n// ===============================\n// 3) METABOX ADMIN \"DOCUMENTS CLIENT\" (INCHANGÉE)\n// ===============================\nadd_action('add_meta_boxes', 'ajouter_meta_boxes_documents');\nfunction ajouter_meta_boxes_documents() {\n    add_meta_box(\n        'documents_commande',\n        'Documents client',\n        'afficher_meta_box_documents',\n        'shop_order',\n        'side',\n        'default'\n    );\n}\n\n// Cette fonction est appelée pour afficher le contenu de la metabox\nfunction afficher_meta_box_documents($post) {\n    // Ajouter les styles CSS\n    echo get_documents_metabox_css();\n    \n    // 1) Affiche la liste des documents déjà présents avec cases à cocher\n    echo '<div class=\"doc-metabox-section\">';\n    echo '<form id=\"bulk-delete-form\" method=\"POST\" action=\"' . esc_url(admin_url('admin-post.php')) . '\">';\n    echo '<input type=\"hidden\" name=\"action\" value=\"bulk_delete_pdf_clients\" />';\n    echo '<input type=\"hidden\" name=\"post_id\" value=\"' . intval($post->ID) . '\" />';\n    wp_nonce_field('bulk_delete_pdf_clients_nonce', 'bulk_delete_pdf_clients_nonce');\n    \n    afficher_documents_avec_checkboxes($post->ID, 'admin');\n    \n    echo '<div class=\"bulk-actions-row\">';\n    echo '<button type=\"button\" id=\"select-all-docs\" class=\"doc-select-all-btn\">Tout sélectionner</button>';\n    echo '<button type=\"submit\" id=\"bulk-delete-btn\" class=\"doc-bulk-delete-btn\" disabled>Supprimer la sélection</button>';\n    echo '</div>';\n    echo '</form>';\n    echo '</div>';\n    \n    // 2) Formulaire d'upload\n    echo '<div class=\"doc-metabox-section doc-upload-section\">';\n    echo '<h4 class=\"doc-section-title\">Ajouter un document</h4>';\n    \n    echo '<form action=\"' . esc_url(admin_url('admin-post.php')) . '\" method=\"POST\" enctype=\"multipart/form-data\">';\n    // Action pour le hook\n    echo '<input type=\"hidden\" name=\"action\" value=\"upload_pdfclients\" />';\n    // ID de la commande\n    echo '<input type=\"hidden\" name=\"post_id\" value=\"' . intval($post->ID) . '\" />';\n    // Nonce pour la sécurité\n    wp_nonce_field('upload_pdfclients_nonce', 'upload_pdfclients_nonce');\n    \n    // Type de document et numéro d'avenant\n    echo '<div class=\"doc-form-row\">';\n    echo '<select name=\"doc_type\" id=\"doc_type\" class=\"doc-select\">';\n    echo '<option value=\"devis\">Devis</option>';\n    echo '<option value=\"convention\">Convention</option>';\n    echo '<option value=\"avenant\">Avenant</option>';\n    echo '</select>';\n    echo '<input type=\"number\" name=\"avenant_num\" id=\"avenant_num\" class=\"doc-input\" placeholder=\"N°\" />';\n    echo '</div>';\n    \n    // Upload et bouton de soumission\n    echo '<div class=\"doc-form-row\">';\n    echo '<div class=\"doc-file-upload\">';\n    echo '<input type=\"file\" id=\"custom_pdf_upload\" name=\"custom_pdf_upload\" accept=\"application/pdf\" />';\n    echo '<label for=\"custom_pdf_upload\" class=\"doc-file-label\">';\n    echo '<span class=\"doc-file-icon\"></span>';\n    echo '<span class=\"doc-file-text\">Choisir un fichier</span>';\n    echo '</label>';\n    echo '<div id=\"file-chosen\" class=\"doc-file-chosen\">Aucun fichier choisi</div>';\n    echo '</div>';\n    echo '</div>';\n    \n    echo '<div class=\"doc-form-row\">';\n    echo '<button type=\"submit\" class=\"doc-submit-btn\"><span class=\"doc-submit-icon\"></span>Téléverser</button>';\n    echo '</div>';\n    \n    echo '</form>';\n    echo '</div>';\n    \n    // JS : comportement dynamique\n    ?>\n    <script>\n    jQuery(document).ready(function($) {\n        // Gestion du champ avenant\n        var $docType = $(\"#doc_type\");\n        var $avenantField = $(\"#avenant_num\");\n        \n        function toggleAvenant() {\n            if ($docType.val() === \"avenant\") {\n                $avenantField.show();\n            } else {\n                $avenantField.hide().val(\"\");\n            }\n        }\n        \n        $docType.on(\"change\", toggleAvenant);\n        toggleAvenant(); // Exécuter au chargement\n        \n        // Gestion de l'affichage du fichier sélectionné\n        $(\"#custom_pdf_upload\").on(\"change\", function() {\n            var fileName = $(this).val().split('\\\\').pop();\n            if (fileName) {\n                $(\"#file-chosen\").text(fileName).addClass('doc-file-selected');\n            } else {\n                $(\"#file-chosen\").text(\"Aucun fichier choisi\").removeClass('doc-file-selected');\n            }\n        });\n        \n        // Confirmation de suppression\n        $(\".delete-pdf-link\").on(\"click\", function(e) {\n            if (!confirm(\"Êtes-vous sûr de vouloir supprimer ce document ?\")) {\n                e.preventDefault();\n            }\n        });\n    });\n    </script>\n    <?php\n}\n\n// Fonction pour générer le CSS de la metabox (INCHANGÉE)\nfunction get_documents_metabox_css() {\n    return '<style>\n        /* Variables CSS */\n        :root {\n            --doc-primary: #4a6fdc;\n            --doc-primary-hover: #3a5ecc;\n            --doc-light-bg: #f8f9fa;\n            --doc-border: #dee2e6;\n            --doc-text: #333;\n            --doc-success: #28a745;\n            --doc-warning: #ffc107;\n            --doc-danger: #dc3545;\n        }\n        \n        /* Styles généraux */\n        .doc-metabox-section {\n            margin-bottom: 10px;\n            font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, Oxygen-Sans, Ubuntu, Cantarell, \"Helvetica Neue\", sans-serif;\n            font-size: 12px;\n        }\n        \n        .doc-section-title {\n            font-size: 12px;\n            margin: 0 0 6px;\n            padding-bottom: 4px;\n            border-bottom: 1px solid var(--doc-border);\n            color: var(--doc-text);\n            font-weight: 600;\n        }\n        \n        .doc-form-row {\n            margin-bottom: 8px;\n            display: flex;\n            gap: 6px;\n            align-items: center;\n        }\n        \n        /* Select et Input */\n        .doc-select, .doc-input {\n            height: 28px;\n            border-radius: 3px;\n            border: 1px solid var(--doc-border);\n            padding: 0 6px;\n            font-size: 11px;\n            transition: all 0.2s ease;\n        }\n        \n        .doc-select {\n            flex: 2;\n            -webkit-appearance: none;\n            background-image: url(\"data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'10\\' height=\\'6\\' viewBox=\\'0 0 10 6\\'%3E%3Cpath fill=\\'%23666\\' d=\\'M0 0h10L5 6z\\'/%3E%3C/svg%3E\");\n            background-repeat: no-repeat;\n            background-position: right 10px center;\n            padding-right: 25px;\n        }\n        \n        .doc-input {\n            flex: 1;\n            display: none; /* Caché par défaut */\n\t\t\tmax-width: 40% !important;\n        }\n        \n        .doc-select:focus, .doc-input:focus {\n            border-color: var(--doc-primary);\n            box-shadow: 0 0 0 1px var(--doc-primary);\n            outline: none;\n        }\n        \n        /* Upload de fichier */\n        .doc-file-upload {\n            width: 100%;\n            position: relative;\n        }\n        \n        .doc-file-upload input[type=\"file\"] {\n            position: absolute;\n            left: -9999px;\n        }\n        \n        .doc-file-label {\n            display: flex;\n            align-items: center;\n            gap: 6px;\n            padding: 6px 10px;\n            background-color: var(--doc-light-bg);\n            border: 1px dashed var(--doc-border);\n            border-radius: 3px;\n            cursor: pointer;\n            transition: all 0.2s ease;\n            width: 100%;\n            margin-bottom: 6px;\n\t\t\tmax-width: 90% !important;\n        }\n        \n        .doc-file-label:hover {\n            border-color: var(--doc-primary);\n            background-color: rgba(74, 111, 220, 0.05);\n        }\n        \n        .doc-file-icon {\n            width: 18px;\n            height: 18px;\n            background-image: url(\"data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' fill=\\'none\\' viewBox=\\'0 0 24 24\\' stroke=\\'%234a6fdc\\'%3E%3Cpath stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'2\\' d=\\'M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12\\'/%3E%3C/svg%3E\");\n            background-size: contain;\n            background-repeat: no-repeat;\n        }\n        \n        .doc-file-text {\n            font-size: 11px;\n            color: var(--doc-text);\n        }\n        \n        .doc-file-chosen {\n            font-size: 10px;\n            color: #777;\n            padding: 2px 6px;\n            overflow: hidden;\n            text-overflow: ellipsis;\n            white-space: nowrap;\n            border-radius: 2px;\n        }\n        \n        .doc-file-selected {\n            background-color: rgba(40, 167, 69, 0.1);\n            color: #28a745;\n            padding: 2px 6px;\n            border-left: 2px solid #28a745;\n        }\n        \n        /* Bouton de soumission */\n        .doc-submit-btn {\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            gap: 6px;\n            background-color: var(--doc-primary);\n            color: white;\n            border: none;\n            border-radius: 3px;\n            padding: 6px 12px;\n            font-size: 11px;\n            font-weight: 500;\n            cursor: pointer;\n            transition: all 0.2s ease;\n            width: 100%;\n        }\n        \n        .doc-submit-btn:hover {\n            background-color: var(--doc-primary-hover);\n        }\n        \n        .doc-submit-icon {\n            width: 16px;\n            height: 16px;\n            background-image: url(\"data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' fill=\\'none\\' viewBox=\\'0 0 24 24\\' stroke=\\'white\\'%3E%3Cpath stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'2\\' d=\\'M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12\\'/%3E%3C/svg%3E\");\n            background-size: contain;\n            background-repeat: no-repeat;\n        }\n        \n        /* Bouton de suppression */\n        .dashicons-trash {\n            color: var(--doc-danger);\n            transition: transform 0.2s ease;\n        }\n        .dashicons-trash:hover {\n            transform: scale(1.2);\n        }\n    </style>';\n}\n\n// ===============================\n// 4) GÉRER LE UPLOAD (admin-post.php) - INCHANGÉ\n// ===============================\nadd_action('admin_post_upload_pdfclients', 'traiter_upload_pdfclients');\nfunction traiter_upload_pdfclients() {\n    // Vérifier le nonce\n    if (!isset($_POST['upload_pdfclients_nonce']) || \n        !wp_verify_nonce($_POST['upload_pdfclients_nonce'], 'upload_pdfclients_nonce')) {\n        wp_die('Security check failed.');\n    }\n\n    // Récupérer l'ID de la commande (post_id)\n    if (!isset($_POST['post_id'])) {\n        wp_die('Missing post_id.');\n    }\n    $post_id = intval($_POST['post_id']);\n\n    // Vérifier les capacités : l'utilisateur doit pouvoir éditer la commande\n    if (!current_user_can('edit_post', $post_id)) {\n        wp_die('Not allowed.');\n    }\n\n    // Récupérer doc_type et avenant_num\n    $doc_type = isset($_POST['doc_type']) ? sanitize_text_field($_POST['doc_type']) : '';\n    $avenant_num = isset($_POST['avenant_num']) ? intval($_POST['avenant_num']) : 0;\n\n    // Vérifier si on a bien un fichier PDF\n    if (!empty($_FILES['custom_pdf_upload']['name'])) {\n        $uploaded_file = $_FILES['custom_pdf_upload'];\n\n        // Construire le nom de fichier en fonction du type\n        switch ($doc_type) {\n            case 'devis':\n                $filename = 'devis-' . $post_id . '.pdf';\n                break;\n            case 'convention':\n                $filename = 'convention-' . $post_id . '.pdf';\n                break;\n            case 'avenant':\n                if ($avenant_num > 0) {\n                    $filename = 'avenant-' . $post_id . '-n' . $avenant_num . '.pdf';\n                } else {\n                    $filename = 'avenant-' . $post_id . '.pdf';\n                }\n                break;\n            default:\n                $filename = 'document-' . $post_id . '.pdf';\n        }\n\n        // Construire le chemin final\n        $upload_dir = wp_upload_dir();\n        $upload_path = $upload_dir['basedir'] . '/pdfclients/';\n        if (!file_exists($upload_path)) {\n            wp_mkdir_p($upload_path);\n        }\n\n        $upload_file_path = $upload_path . $filename;\n\n        // S'il existe déjà, on l'écrase\n        if (file_exists($upload_file_path)) {\n            unlink($upload_file_path);\n        }\n\n        // Déplacer le fichier temporaire\n        move_uploaded_file($uploaded_file['tmp_name'], $upload_file_path);\n    }\n\n    // Rediriger vers la page d'édition de la commande\n    wp_redirect(\n        add_query_arg(\n            array('post' => $post_id, 'action' => 'edit', 'uploaded' => '1'),\n            admin_url('post.php')\n        )\n    );\n    exit;\n}\n\n// ===============================\n// 5) GÉRER LA SUPPRESSION (admin-post.php) - INCHANGÉ\n// ===============================\nadd_action('admin_post_delete_pdf_client', 'supprimer_pdf_client');\nfunction supprimer_pdf_client() {\n    // Vérifier les capacités\n    if (!current_user_can('edit_posts')) {\n        wp_die('Not allowed.');\n    }\n\n    // Vérifier le nonce\n    if (!isset($_GET['_wpnonce']) || !isset($_GET['file']) || !isset($_GET['post_id'])) {\n        wp_die('Invalid request.');\n    }\n\n    $file = sanitize_text_field(urldecode($_GET['file']));\n    $post_id = intval($_GET['post_id']);\n    \n    if (!wp_verify_nonce($_GET['_wpnonce'], 'delete_pdf_client_' . $file)) {\n        wp_die('Security check failed.');\n    }\n\n    // Vérifier que l'utilisateur peut modifier cette commande\n    if (!current_user_can('edit_post', $post_id)) {\n        wp_die('Not allowed to edit this order.');\n    }\n\n    // Chemin du fichier\n    $upload_dir = wp_upload_dir();\n    $file_path = $upload_dir['basedir'] . '/pdfclients/' . $file;\n\n    // Vérifier que le fichier existe et est dans le bon dossier\n    if (file_exists($file_path) && strpos($file_path, $upload_dir['basedir'] . '/pdfclients/') === 0) {\n        unlink($file_path);\n    }\n\n    // Rediriger vers la page d'édition de la commande\n    wp_redirect(\n        add_query_arg(\n            array('post' => $post_id, 'action' => 'edit', 'deleted' => '1'),\n            admin_url('post.php')\n        )\n    );\n    exit;\n}",
  "tags": "",
  "scope": "global",
  "priority": "10",
  "active": true,
  "modified": "2025-07-09 21:42:44",
  "revision": "99",
  "cloud_id": null
}