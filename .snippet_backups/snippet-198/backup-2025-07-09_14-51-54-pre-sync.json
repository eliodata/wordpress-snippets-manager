{
  "id": "198",
  "name": "Metabox side Suivi Rapprochement Commande WooCommerce",
  "description": "Ajoute une metabox de 'Suivi Rapprochement' sur les pages de commande WooCommerce. Cet outil permet de suivre l'avancement du traitement de chaque commande à l'aide d'une checklist d'étapes clés. Une barre de progression visuelle et un pourcentage indiquent le statut global, offrant une vue rapide et efficace de l'état de chaque commande.  Active: true  Active: true  Active: true  Active: true  Active: true  Active: true  Active: true  Active: true  Active: true  Active: true",
  "code": "/**\n * Metabox pour le suivi de rapprochement des commandes WooCommerce\n * À ajouter dans functions.php ou dans un plugin\n */\n\n// Ajouter la metabox\nadd_action('add_meta_boxes', 'fsbdd_add_rapprochement_metabox');\n\nfunction fsbdd_add_rapprochement_metabox() {\n    add_meta_box(\n        'fsbdd_rapprochement_metabox',\n        'Suivi Rapprochement',\n        'fsbdd_rapprochement_metabox_content',\n        'shop_order',\n        'side',\n        'high'\n    );\n}\n\n// Contenu de la metabox\nfunction fsbdd_rapprochement_metabox_content($post) {\n    // Sécurité avec nonce\n    wp_nonce_field('fsbdd_rapprochement_metabox', 'fsbdd_rapprochement_nonce');\n    \n    // Liste des étapes de rapprochement\n    $etapes = array(\n        'session' => 'Session OK',\n        'specificites' => 'Spécificités OK',\n        'convocations' => 'Convocations OK',\n        'quantites_couts' => 'Quantités, Coûts, Frais & TVA OK',\n        'subro_reglements' => 'Subro & Règlements OK',\n        'client_bdd_web' => 'Client BDD & Web OK'\n    );\n    \n    // Récupérer les valeurs existantes\n    $valeurs_actuelles = array();\n    foreach ($etapes as $key => $label) {\n        $valeurs_actuelles[$key] = get_post_meta($post->ID, 'fsbdd_rappro_' . $key, true);\n    }\n    \n    echo '<div class=\"fsbdd-rapprochement-container\">';\n    echo '<style>\n        .fsbdd-rapprochement-container {\n            padding: 0;\n        }\n        .fsbdd-rapprochement-container .etape {\n            display: flex;\n            align-items: center;\n            margin-bottom: 2px;\n            padding: 3px 5px;\n            border-radius: 3px;\n            transition: background-color 0.2s;\n        }\n        .fsbdd-rapprochement-container .etape.etape-ok label {\n            color: #3c8c42;\n        }\n        .fsbdd-rapprochement-container .etape input[type=\"checkbox\"] {\n            margin-right: 8px;\n            width: 16px;\n            height: 16px;\n            accent-color: #4caf50;\n        }\n        .fsbdd-rapprochement-container .etape label {\n            flex-grow: 1;\n            margin: 0;\n            font-size: 13px;\n            font-weight: normal;\n            cursor: pointer;\n        }\n        .fsbdd-rapprochement-progress-container {\n            margin-top: 8px;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n        }\n        .fsbdd-rapprochement-progress-bar {\n            background-color: #e0e0e0;\n            border-radius: 4px;\n            overflow: hidden;\n            height: 8px;\n            flex-grow: 1;\n        }\n        .fsbdd-rapprochement-progress-fill {\n            background-color: #4caf50;\n            width: 0%;\n            height: 100%;\n            transition: width 0.4s ease-in-out;\n        }\n        .fsbdd-rapprochement-progress-text {\n            font-size: 11px;\n            font-weight: bold;\n            white-space: nowrap;\n        }\n    </style>';\n\n    // Afficher les cases à cocher\n    foreach ($etapes as $key => $label) {\n        $checked = checked($valeurs_actuelles[$key], '1', false);\n        $class = $valeurs_actuelles[$key] ? ' etape-ok' : '';\n        \n        echo '<div class=\"etape' . $class . '\">';\n        echo '<input type=\"checkbox\" id=\"fsbdd_rappro_' . $key . '\" name=\"fsbdd_rappro_' . $key . '\" value=\"1\" ' . $checked . '>';\n        echo '<label for=\"fsbdd_rappro_' . $key . '\">' . esc_html($label) . '</label>';\n        echo '</div>';\n    }\n    \n    // Indicateur de progression\n    $total_etapes = count($etapes);\n    $etapes_completees = count(array_filter($valeurs_actuelles));\n    $pourcentage = $total_etapes > 0 ? round(($etapes_completees / $total_etapes) * 100) : 0;\n    \n    echo '<div class=\"fsbdd-rapprochement-progress-container\">';\n    echo '  <div class=\"fsbdd-rapprochement-progress-bar\">';\n    echo '    <div class=\"fsbdd-rapprochement-progress-fill\" style=\"width: ' . $pourcentage . '%;\"></div>';\n    echo '  </div>';\n    echo '  <div class=\"fsbdd-rapprochement-progress-text\">' . $etapes_completees . '/' . $total_etapes . ' (' . $pourcentage . '%)</div>';\n    echo '</div>';\n    \n    echo '</div>';\n}\n\n// Sauvegarder les données\nadd_action('save_post', 'fsbdd_save_rapprochement_metabox');\n\nfunction fsbdd_save_rapprochement_metabox($post_id) {\n    // Vérifications de sécurité\n    if (!isset($_POST['fsbdd_rapprochement_nonce']) || \n        !wp_verify_nonce($_POST['fsbdd_rapprochement_nonce'], 'fsbdd_rapprochement_metabox')) {\n        return;\n    }\n    \n    if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) {\n        return;\n    }\n    \n    if (!current_user_can('edit_post', $post_id)) {\n        return;\n    }\n    \n    // Vérifier que c'est bien une commande\n    if (get_post_type($post_id) !== 'shop_order') {\n        return;\n    }\n    \n    // Liste des champs à sauvegarder\n    $champs = array(\n        'session',\n        'specificites', \n        'convocations',\n        'quantites_couts',\n        'subro_reglements',\n        'client_bdd_web'\n    );\n    \n    // Sauvegarder chaque champ\n    foreach ($champs as $champ) {\n        $meta_key = 'fsbdd_rappro_' . $champ;\n        $valeur = isset($_POST[$meta_key]) ? '1' : '0';\n        update_post_meta($post_id, $meta_key, $valeur);\n    }\n}\n\n// Ajouter une colonne dans la liste des commandes (optionnel)\nadd_filter('manage_edit-shop_order_columns', 'fsbdd_add_rapprochement_column');\n\nfunction fsbdd_add_rapprochement_column($columns) {\n    $columns['rapprochement'] = 'Rapprochement';\n    return $columns;\n}\n\nadd_action('manage_shop_order_posts_custom_column', 'fsbdd_display_rapprochement_column', 10, 2);\n\nfunction fsbdd_display_rapprochement_column($column, $post_id) {\n    if ($column === 'rapprochement') {\n        $champs = array('session', 'specificites', 'convocations', 'quantites_couts', 'subro_reglements', 'client_bdd_web');\n        $total = count($champs);\n        $completes = 0;\n        \n        foreach ($champs as $champ) {\n            if (get_post_meta($post_id, 'fsbdd_rappro_' . $champ, true) === '1') {\n                $completes++;\n            }\n        }\n        \n        $pourcentage = round(($completes / $total) * 100);\n        $couleur = $pourcentage == 100 ? '#46b450' : ($pourcentage >= 50 ? '#FE8E1B' : '#dc3232');\n        \n        echo '<span style=\"color: ' . $couleur . '; font-weight: bold;\">';\n        echo $completes . '/' . $total . ' (' . $pourcentage . '%)';\n        echo '</span>';\n    }\n}\n\n// Fonction helper pour récupérer l'état d'une étape\nfunction fsbdd_get_rapprochement_status($order_id, $etape) {\n    return get_post_meta($order_id, 'fsbdd_rappro_' . $etape, true) === '1';\n}\n\n// Fonction helper pour récupérer le pourcentage de completion\nfunction fsbdd_get_rapprochement_percentage($order_id) {\n    $champs = array('session', 'specificites', 'convocations', 'quantites_couts', 'subro_reglements', 'client_bdd_web');\n    $total = count($champs);\n    $completes = 0;\n    \n    foreach ($champs as $champ) {\n        if (get_post_meta($order_id, 'fsbdd_rappro_' . $champ, true) === '1') {\n            $completes++;\n        }\n    }\n    \n    return round(($completes / $total) * 100);\n}\n\n\n// Ajouter une metabox personnalisée sur la page d'accueil de l'admin\nadd_action('admin_init', 'fsbdd_add_dashboard_rapprochement_metabox');\n\nfunction fsbdd_add_dashboard_rapprochement_metabox() {\n    add_action('welcome_panel', 'fsbdd_dashboard_rapprochement_metabox_content');\n}\n\nfunction fsbdd_dashboard_rapprochement_metabox_content() {\n    // Récupérer les commandes récentes\n    $recent_orders = wc_get_orders(array(\n        'limit' => 10,\n        'orderby' => 'date',\n        'order' => 'DESC',\n    ));\n\n    echo '<div class=\"fsbdd-dashboard-rapprochement-container\">';\n    echo '<h2>Résumé des Rapprochements</h2>';\n\n    foreach ($recent_orders as $order) {\n        $order_id = $order->get_id();\n        $percentage = fsbdd_get_rapprochement_percentage($order_id);\n\n        echo '<div class=\"fsbdd-dashboard-order-summary\">';\n        echo '<p><strong>Commande #' . $order_id . '</strong> - Progression : ' . $percentage . '%</p>';\n        echo '</div>';\n    }\n\n    echo '</div>';\n}",
  "tags": "woocommerce, commande, order, metabox, suivi, rapprochement, checklist, progression, productivité",
  "scope": "admin",
  "priority": "10",
  "active": true,
  "modified": "2025-07-09 14:50:50",
  "revision": "89",
  "cloud_id": null
}